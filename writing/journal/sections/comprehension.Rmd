# Experiment 2: Comprehension

Our first experiment found that young children are able to coordinate on pacts with their parents.
Even four-year-olds readily adopted the labels introduced by their parents and interactively refined their descriptions in response to spontaneous parent-initiated repair.
So why do younger children struggle so much with their peers?
One possibility is that the difficulty lies primarily in the process of *comprehension*. 
Children might be poor listeners.
They may be unable to understand or accommodate their partner's description if it does not align with their own way of conceptualizing the tangram, preventing uptake of a pact.
Another possibility is that the root of the difficulty primarily lies in *production*.
In other words, children may have difficulty *generating* sufficiently descriptive referring expressions on their own, given their limited vocabulary and other processing constraints, but are able to recognize a good description when they hear it, and adopt that description going forward.

In Experiment 2, we tested the first of these two hypotheses using a comprehension task. 
We provided naive children and adults with the descriptions produced by participants in Experiment 1 and asked how well they were able to interpret them.
If comprehension is the root of the developmental problem, we might expect that naive children would be equally unable to interpret all referring expressions (regardless of whether they were originally produced by adults or children) while naive adults would have no difficulty.
Conversely, if naive children are able to understand the referring expressions produced by parents (and not necessarily those by children), then we may expect the source of the difficulty to be elsewhere.

```{r load-original-games}
# Load meta-data (e.g. age) for the stimuli
database_ids <- read_csv(here("data/experiment2/databaseid.csv"), show_col_types = FALSE) %>%
  rename(gameid = subid) %>%
  select(gameid, age)
```

```{r load-comprehension-data}
raw_adult_data <- read_csv(here("data/experiment2/comprehension_adults.csv"),
                           show_col_types = FALSE) %>%
  select(-age) %>%
  filter(!audioid %in% c("67_08", "67_08_b"))

check_correct <- raw_adult_data %>%
  filter(occurrence == "check") %>%
  mutate(check_correct = correct) %>%
  select(subid, check_correct)

passed_check <- check_correct %>%
  group_by(check_correct) %>%
  count() %>%
  pivot_wider(names_from = check_correct, values_from = n) %>%
  clean_names()

tidy_turk_data <- raw_adult_data %>%
  left_join(check_correct, by = c("subid")) %>%
  filter(check_correct, occurrence != "check") %>%
  separate(audioid, into = c("gameid", "gametrial"), sep = "_", remove = F) %>%
  mutate(gameid = as.numeric(gameid),
         gametrial = as.numeric(gametrial)) %>%
  left_join(database_ids, by = ("gameid")) %>%
  mutate(log_rt = log(reactiontime)) %>%
  pivot_longer(cols = c(correct, reactiontime, log_rt), names_to = "measure") %>%
  mutate(comprehender_group = 'adult',
         occurrence = as.numeric(occurrence))
```


```{r load-kid-data}
# Note: We started with raw, de-anonymized data (comprehension_kids.csv). 
# We have preserved this pipeline for reproducibility but only release 
# the anonymized data (comprehension_kids_tidy.csv).
# kid data
# 
# raw_kid_stims <- read_csv(here("data/experiment2/random_stims.csv"),
#                   show_col_types = FALSE) %>%
#   select(-c(correct, trial, rightpic, leftpic))
# 
# raw_kid_data <- read_csv(here("data/experiment2/comprehension_kids.csv"), show_col_types = FALSE) %>%
#   filter(!is.na(id)) %>%
#   left_join(raw_kid_stims, by = c("id" = "subject", "target")) %>%
#   rename(audioid = audio,
#          trialnum = trial,
#          p_age = age) %>%
#   mutate(correct = correct=="Y") %>%
#   filter(!audioid %in% c("67_08", "67_08_b"))
# 
# tidy_kid_data <- raw_kid_data %>%
#   separate(audioid, into = c("gameid", "gametrial"), sep = "_", remove = F) %>%
#   mutate(gameid = as.numeric(gameid),
#          trial = as.numeric(gametrial)) %>%
#   left_join(database_ids, by = ("gameid")) %>%
#   mutate(log_rt = log(rt)) %>%
#   filter(rt < 10000) %>%
#   pivot_longer(cols = c(correct, rt, log_rt), names_to = "measure")
#   
# write_csv(tidy_kid_data, here('data/experiment2/comprehension_kids_tidy.csv'))

tidy_kid_data <- read_csv(here("data/experiment2/comprehension_kids_tidy.csv"), show_col_types = FALSE) %>%
  select(-subid) %>%
  mutate(subid = as.character(id),
         gametrial = as.numeric(gametrial),
         comprehender_group = 'kid')
```

```{r import-stims}
get_stims <- function(data) {
  data %>%
    unite(audioid, gametrial, gameid) %>% group_by(person) %>% 
    summarize(l = length(unique(audioid))) %>% 
    pivot_wider(names_from = person, values_from = l)
    return()
}

adult_stims <- get_stims(tidy_turk_data)
kid_stims <- get_stims(tidy_kid_data)
```

## Methods

### Participants

We recruited `r passed_check$false + passed_check$true` adults from Amazon Mechanical Turk.
Data from `r passed_check$false` participants were dropped due to failure to complete the study, leaving a final sample of `r passed_check$true` adults. 
Additionally, we planned to recruited a sample of 200 children from a school and a museum in the local community.
However, because of the COVID-19 pandemic, we were forced to terminate data collection early with only `r length(unique(tidy_kid_data$id))` children (ages `r min(tidy_kid_data$age)`-`r max(tidy_kid_data$age)`).

### Stimuli

To conceal the identity of the original speaker, the first author produced new audio recordings by reading the Exp.~1 game transcripts in a uniform vocal style.
We removed disfluencies and isolated the speaker's original referring expression on each trial (i.e. we excluded additional information provided in response to the listener's questions or prompting).
This process produced `r adult_stims$parent + adult_stims$child` unique audio stimuli, one for each trial of each game from Exp.~1. 
These stimuli were broken into 118 unique 'item sets' containing 10 recordings each, such that each tangram appeared as the target once in each set. 

### Procedure

Participants were placed in the role of the listener and presented a sequence of 10 audio recordings --- a single referring expression for each target tangram, in a randomized order, paired with their foils from the corresponding trial in Exp.~1.
At the beginning of each trial, the recording was played and participants were asked to click the intended referent.
To reduce possible learning effects, participants did not receive any feedback after their response.
Before participants began the experiment, we ensured their audio was working. 
We did not allow participants to proceed past the consent page without clicking a 'play' button that asked them to "type the number 86 into the box."
Additionally, to detect participants who were not following instructions, we included an attention check which simply asked people to click 'the one on the left'.
We measured accuracy and response time, measured as the time interval between the completion of the audio recording and the response.
Participants were not allowed to respond prior to the completion of the recording.

### Design 

We used a $2 \times 2$ factorial design manipulating the age of the producer (adult vs. child) and comprehender (adult vs. child). 
The age of the producer was a within-subjects manipulation while the age of the comprehender was an across-subjects manipulate: each comprehender was exposed to utterances originally produced by both adults and children.
We predicted that if children struggle to form conceptual pacts primarily due to *comprehension* difficulties, then adult comprehenders should be highly accurate across the board (regardless of whether the referring expression was originally produced by an adult or child), while child comprehenders should uniformly struggle.

```{r rt-skew, fig.show='hide'}
# We examine RT distributions
bind_rows(tidy_turk_data, tidy_kid_data) %>% 
  filter(measure != "correct") %>%
  ggplot(aes(x = value)) +
  facet_wrap(comprehender_group ~ measure, scales = "free") + 
  geom_histogram()
```


## Results

### Age effects on comprehender performance

```{r descriptive-plots, fig.show='hide'}
comp.means <- bind_rows(tidy_turk_data, tidy_kid_data)  %>%
  filter(measure == "correct") %>%
  group_by(comprehender_group) %>%
  tidyboot_mean(value) %>%
  select(-n, -empirical_stat) %>% 
  pivot_wider(names_from = comprehender_group, values_from = c(ci_lower, mean, ci_upper))

bind_rows(tidy_turk_data, tidy_kid_data)  %>%
  filter(measure == "correct") %>%
  group_by(audioid, comprehender_group) %>%
  summarise(value = mean(value)) %>%
  # tidyboot_mean(value)
  # simple_effects %>%
  ggplot(aes(x = as.factor(comprehender_group), y = value, group = audioid)) +
    geom_line(position = position_jitter(w=0.05, h=0.05), alpha = 0.1) +
    theme_few()
```

To test whether age effects in reference game performance may be attributed to comprehension difficulties, we compared the extent to which a naive group of children and adults were able to determine the referent of the same expressions.
We focus primarily on accuracy, as response times are not directly comparable between the web interface (for adults) and lab interface (for children).
We constructed a mixed-effects logistic regression model predicting trial-by-trial accuracy, including a fixed effect of comprehender group (child vs. adult) and random intercepts and slopes for each source description.
We found no significant difference in overall accuracy across groups, $t=1.6, p = 0.11$, (adult accuracy $=$ `r comp.means$mean_adult`, 95\% CI $=$ [`r comp.means$ci_lower_adult`, `r comp.means$ci_upper_adult`], child accuracy $=$ `r comp.means$mean_kid`, 95\% CI $=$ `r comp.means$ci_lower_kid`, `r comp.means$ci_upper_kid`).^[A Bayesian regression ]


```{r}
group_diff.glmer <- bind_rows(tidy_turk_data, tidy_kid_data)  %>%
  filter(measure == "correct") %>%
  glmer(as.logical(value) ~ comprehender_group + (1 | audioid),
       data = .,
       family = binomial,
       control = glmerControl(optimizer = 'bobyqa')) %>%
  tidy()

group_diff.brm1 <- bind_rows(tidy_turk_data, tidy_kid_data) %>%
  filter(measure == "correct") %>%
  brms::brm(value ~ 1 + (1 | audioid),
       data = .,
       family = 'bernoulli')


group_diff.brm2 <- bind_rows(tidy_turk_data, tidy_kid_data) %>%
  filter(measure == "correct") %>%
  brms::brm(value ~ comprehender_group + (1 | audioid),
       data = .,
       family = 'bernoulli') %>%
  tidy()

loo_compare(fit1, fit2, criterion = "waic")

group_diff.brm
```


```{r}
#kid plots
kid_subj_data <- tidy_kid_data %>%
  filter(measure != "rt") %>% #exclude 17
  group_by(age, person, occurrence, measure, gameid) %>%
  summarise(value = mean(value))

kid_simple_effects <- kid_subj_data %>%
  tidyboot_mean(value)

kid_simple_effects %>% 
  ggplot(aes(x = as.factor(age), y = empirical_stat, color = person)) +
  facet_grid(measure ~ occurrence, scales = "free") + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(.5)) +
  theme_few()
```

### Speaker effects on comprehension

Next, we consider... Accuracy and RT as a function of age, person, occurrence

Models from Pre-reg

We will fit a logistic mixed effects model predicting informativeness from person (parent/child), age of child in the pair (4, 6, 8), trial (1 vs 2) and all of their interactions.

```{r full-acc-lmer}
full_acc_lmer <- tidy_turk_data %>%
  filter(measure == "correct") %>%
  glmer(value ~ person * age * occurrence + 
                   (1|target) ,
       family = "binomial", data = .) %>%
  tidy() %>%
  filter(effect == "fixed") %>%
  select(-effect, -group)

full_acc_lmer

#kid model

kid_full_acc_lmer <- tidy_kid_data %>%
  filter(measure == "correct") %>%
  glmer(value ~ person * age * occurrence + 
                   (1|target) ,
       family = "binomial", data = .) %>%
  tidy() %>%
  filter(effect == "fixed") %>%
  select(-effect, -group)

kid_full_acc_lmer

```

```{r reduced-acc-lmer}
acc_lmer <- tidy_turk_data %>%
  filter(measure == "correct") %>%
  glmer(value ~ person + age + occurrence  + 
                   (1|target) + (1|subid), 
        family = "binomial", data = .) %>%
  tidy() %>%
  filter(effect == "fixed") %>%
  select(-effect, -group)

acc_lmer

#kid model
kid_acc_lmer <- tidy_kid_data %>%
  filter(measure == "correct") %>%
  glmer(value ~ person + age + occurrence  + 
                   (1|target) + (1|subid), 
        family = "binomial", data = .) %>%
  tidy() %>%
  filter(effect == "fixed") %>%
  select(-effect, -group)

kid_acc_lmer

#two-way
kid_two_way_lmer <- tidy_kid_data %>%
  filter(measure == "correct") %>%
  glmer(value ~ person*occurrence + age + 
                   (1|target) + (1|subid), 
        family = "binomial", data = .) %>%
  tidy() %>%
  filter(effect == "fixed") %>%
  select(-effect, -group)

kid_two_way_lmer

```

```{r full-rt-lmer}
full_rt_lmer <- tidy_turk_data %>%
  filter(measure == "log_rt") %>%
  lmer(value ~ person * age * occurrence + 
                   (1|target) + (1|subid), data = .) %>%
  tidy() %>%
  filter(effect == "fixed") %>%
  select(-effect, -group)

full_rt_lmer
```

```{r reduced-rt-lmer}
rt_lmer <- tidy_turk_data %>%
  filter(measure == "log_rt") %>%
  lmer(value ~ person + age + occurrence  + 
                   (1|target) + (1|subid), data = .) %>%
  tidy() %>%
  filter(effect == "fixed") %>%
  select(-effect, -group)

rt_lmer
```


So parents' descriptions lead to more accurate and faster guesses. Both older kids and parents of older kids give better descriptions. 

But no effect of occurrence--descriptions on the second appearance of each item do not appear to contain less information for guessing the target.

```{r exchange-data}
turk_exchange_data <- d.exchanges.raw %>% 
  group_by(trial, subid) %>% 
  summarise(num_exchanges = sum(num_exchanges)) %>% 
  right_join(tidy_turk_data, by = c("subid" = "gameid"), "trial" = "gametrial")

turk_exchange_data %>%
  filter(measure == "correct") %>%
  group_by(age, num_exchanges, person) %>%
  summarise(value = mean(value)) %>%
  ggplot(aes(x = num_exchanges, y = value, color = as.factor(age))) +
  facet_wrap(~ person) +
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE)
```