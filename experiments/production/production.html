<!DOCTYPE html>
<html>
  <head>
    <title>Tangram Production</title>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-external-html.js"></script>
    <script type="text/javascript" src="consent/consent.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css"></link>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  </head>
  <body></body>

    <script>

    /* get info from turk */
    var turkInfo = jsPsych.turk.turkInfo();

    /* create timeline */
    var timeline = [];


    // reCAPTCHA object
    // var recaptcha = {
    //   type: "external-html",
    //   url: "recaptcha.html",
    //   cont_btn: "submit_button",
    //   execute_script: true
    // };
    // timeline.push(recaptcha);

    // consent form
    var consent = {
      type:'external-html',
      url: "consent/consent.html",
      cont_btn: "start"
    };
      //timeline.push(consent);

    // trials

    var instructions = {
      type: "html-button-response",
      stimulus: "<p>In this experiment, you will see one or more pictures on the screen at a time.</p><p>One of the objects will be in a <span style='color:blue'>blue box</span>.</p><p>Please describe this object as best as you can in <strong>one word</strong>.</p><p>If there are multiple objects, describe the object in the <span style='color:blue'>blue box</span> so that someone else could guess which one of the two objects is in the <span style='color:blue'>blue box</span>.</p>",
      choices: ['Start'],
      data: {test_part: 'setup'},
      post_trial_gap: 1000
    };
    timeline.push(instructions);

    var iso_item_block = {
      type: "html-button-response",
      stimulus: "<p>In this block, you will see one picture on the screen at a time.</p><p>Please describe this object as best as you can in <strong>one word</strong>.</p><p>",
      choices: ['Continue'],
      data: {test_part: 'block-setup'},
      post_trial_gap: 500
    };

    var paired_item_block = {
      type: "html-button-response",
      stimulus: "<p>In this block, you will see two pictures on the screen at a time.</p><p>One of the objects will be in a <span style='color:blue'>blue box</span>.</p><p>Please describe this object as best as you can in <strong>one word</strong> so that someone else could guess which of the two objects is in the <span style='color:blue'>blue box</span>.</p>",
      choices: ['Continue'],
      data: {test_part: 'block-setup'},
      post_trial_gap: 500
    };


    var close_tangrams = [
        {target: "images/A1.jpg", foil: "images/A2.jpg"},
        {target: "images/E1.jpg", foil: "images/F1.jpg"},
        {target: "images/G1.jpg", foil: "images/M1.jpg"},
        {target: "images/I1.jpg", foil: "images/J1.jpg"},
        {target: "images/B1.jpg", foil: "images/P1.jpg"},
        {target: "images/F1.jpg", foil: "images/W1.jpg"},
        {target: "images/H1.jpg", foil: "images/Y1.jpg"},
        {target: "images/K1.jpg", foil: "images/T1.jpg"},
    ];

    var far_tangrams = [
        {target: "images/A1.jpg", foil: "images/D1.jpg"},
        {target: "images/E1.jpg", foil: "images/C2.jpg"},
        {target: "images/G1.jpg", foil: "images/N1.jpg"},
        {target: "images/I1.jpg", foil: "images/R1.jpg"},
        {target: "images/B1.jpg", foil: "images/O1.jpg"},
        {target: "images/F1.jpg", foil: "images/C1.jpg"},
        {target: "images/H1.jpg", foil: "images/A2.jpg"},
        {target: "images/K1.jpg", foil: "images/V1.jpg"},
    ];

    var close_familiar = [
      {target: "images/germanshepherd.jpg", foil: "images/pug.jpg"},
      {target: "images/sparrow.jpg", foil: "images/eagle.jpg"},
      {target: "images/grizzlybear.jpg", foil: "images/polarbear.jpg"},
      {target: "images/goldfish.jpg", foil: "images/swordfish.jpg"},
      {target: "images/mnms.jpg", foil: "images/gummybears.jpg"},
      {target: "images/sedan.jpg", foil: "images/sportscar.jpg"},
      {target: "images/diningtable.jpg", foil: "images/picnictable.jpg"},
      {target: "images/tshirt.jpg", foil: "images/dressshirt.jpg"}
    ];
      
    var far_familiar = [
      {target: "images/germanshepherd.jpg", foil: "images/cow.jpg"},
      {target: "images/sparrow.jpg", foil: "images/squirrel.jpg"},
      {target: "images/grizzlybear.jpg", foil: "images/lion.jpg"},
      {target: "images/goldfish.jpg", foil: "images/iguana.jpg"},
      {target: "images/mnms.jpg", foil: "images/pretzels.jpg"},
      {target: "images/sedan.jpg", foil: "images/firetruck.jpg"},
      {target: "images/diningtable.jpg", foil: "images/wardrobe.jpg"},
      {target: "images/tshirt.jpg", foil: "images/dress.jpg"}
    ];

    var all_imgs = _.flatten(_.map(
      close_tangrams.concat(far_tangrams, close_familiar, far_familiar),
      v => {
        return [v.target, v.foil];
      }
    ));

    var iso_trial = {
      type: "survey-text",
      preamble: function(){
        var target = ("<img style='border: 10px solid blue; margin: 50px' src='" +
                      jsPsych.timelineVariable('target', true) +
                      "' height='200px'>");
        return target;
      },
      questions: [{prompt: "Describe the object in the <span style='color:blue'>blue border</span> in <strong>one word</strong>", required: true, columns: 20}],
      post_trial_gap: 500
    };

    var paired_trial = {
      type: "survey-text",
      preamble: function(){
        var target = ("<img style='border: 10px solid blue; margin: 50px' src='" +
                      jsPsych.timelineVariable('target', true) +
                      "' height='200px'>");
        var foil = ("<img style='margin: 50px' src='" +
                    jsPsych.timelineVariable('foil', true)+
                    "' height='200px'>");
        return _.shuffle([target, foil]).join('');
      },
      questions: [{prompt: "Describe the object in the <span style='color:blue'>blue border</span> in <strong>one word</strong> that uniquely identifes it compared to the other one", required: true, columns: 20}],
      //data: {trial_type: "paired"},//, target: jsPsych.timelineVariable('target')},
      post_trial_gap: 500
    };

    var tangram_close_trial = {
      timeline: [paired_trial],
      timeline_variables: close_tangrams,
      randomize_order: true,
      repetitions: 1,
      data: {competitor_type: "paired", target_type: "tangram",
      test_part: 'trial'}
    };


    var tangram_far_trial = {
      timeline: [paired_trial],
      timeline_variables: far_tangrams,
      randomize_order: true,
      repetitions: 1,
      data: {competitor_type: "paired", target_type: "tangram",
      test_part: 'trial'}
    };

    var tangram_iso_trial = {
      timeline: [iso_trial],
      timeline_variables: close_tangrams,
      randomize_order: true,
      repetitions: 1,
      data: {competitor_type: "isolated", target_type: "tangram",
      test_part: 'trial'}
    };

    var familiar_close_trial = {
      timeline: [paired_trial],
      timeline_variables: close_familiar,
      randomize_order: true,
      repetitions: 1,
      data: {competitor_type: "paired", target_type: "familiar", test_part: 'trial'}
    };

    var familiar_far_trial = {
      timeline: [paired_trial],
      timeline_variables: far_familiar,
      randomize_order: true,
      repetitions: 1,
      data: {competitor_type: "paired", target_type: "familiar", test_part: 'trial'}
    };

    var familiar_iso_trial = {
      timeline: [iso_trial],
      timeline_variables: close_familiar,
      randomize_order: true,
      repetitions: 1,
      data: {competitor_type: "paired", target_type: "familiar", test_part: 'trial'}
    };

    var alltrials = jsPsych.randomization.sampleWithoutReplacement([tangram_close_trial, tangram_far_trial, tangram_iso_trial,familiar_close_trial, familiar_far_trial, familiar_iso_trial], 6);

    for (i = 0; i < alltrials.length; i++) {
      if(alltrials[i].data.trialtype == "paired")
        timeline.push(paired_item_block)
      else
        timeline.push(iso_item_block)

      timeline.push(alltrials[i]);
    }

    jsPsych.init({
      timeline: timeline,
      on_finish: function() {

        var data = jsPsych.data.get().csv();
        jsPsych.turk.submitToTurk(data);
        jsPsych.data.displayData();
      },
      preload_images: all_imgs
    })

    </script>

</html>
